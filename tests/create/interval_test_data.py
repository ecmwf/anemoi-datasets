# (C) Copyright 2025 Anemoi contributors.
#
# This software is licensed under the terms of the Apache Licence Version 2.0
# which can be obtained at http://www.apache.org/licenses/LICENSE-2.0.
#
# In applying this licence, ECMWF does not waive the privileges and immunities
# granted to it by virtue of its status as an intergovernmental organisation
# nor does it submit to any jurisdiction.

from datetime import datetime
from anemoi.datasets.create.sources.accumulate_utils.covering_intervals import SignedInterval

def build_signed_interval(x: str) -> SignedInterval:
    # x is like '20240101.0000 -> 20240101.0300, base=20240101.0000, ...'
    interval_part, *extras = x.split(",")
    interval_part = interval_part.strip()

    start_str, end_str = interval_part.split("->")
    start_str, end_str = start_str.strip(), end_str.strip()

    if len(start_str) == 15:
        start = datetime.strptime(start_str.strip(), "%Y%m%d %H:%M")
    else:
        start = datetime.strptime(start_str.strip(), "%Y%m%d.%H%M")

    if len(end_str) == 4:  # only hour provided, reuse date from start
        end_str = start.strftime("%Y%m%d") + "." + end_str

    if len(end_str) == 15:
        end = datetime.strptime(end_str, "%Y%m%d %H:%M")
    else:
        end = datetime.strptime(end_str, "%Y%m%d.%H%M")

    extras_dict = {}
    for extra in extras:
        key, value = extra.strip().split("=")
        if key == "base":
            extras_dict["base"] = datetime.strptime(value.strip(), "%Y%m%d.%H%M")
        else:
            raise ValueError(f"Unknown extra key: {key}")

    return SignedInterval(start=start, end=end, **extras_dict)

_ = build_signed_interval


ERA_TEST_CASES = [
    # era
    (_("20240101.1800 -> 20240101.2100"), [_("20240101.1800 -> 1900, base=20240101.1800"),
                                           _("20240101.1900 -> 2000, base=20240101.1800"),
                                           _("20240101.2000 -> 2100, base=20240101.1800")]),
    (_("20240101.1800 -> 20240102.0600"), [_("20240101.1800 -> 1900, base=20240101.1800"),
                                           _("20240101.1900 -> 2000, base=20240101.1800"),
                                           _("20240101.2000 -> 2100, base=20240101.1800"),
                                           _("20240101.2100 -> 2200, base=20240101.1800"),
                                           _("20240101.2200 -> 2300, base=20240101.1800"),
                                           _("20240101.2300 -> 20240102.0000, base=20240101.1800"),
                                           _("20240102.0000 -> 0100, base=20240101.1800"),
                                           _("20240102.0100 -> 0200, base=20240101.1800"),
                                           _("20240102.0200 -> 0300, base=20240101.1800"),
                                           _("20240102.0300 -> 0400, base=20240101.1800"),
                                           _("20240102.0400 -> 0500, base=20240101.1800"),
                                           _("20240102.0500 -> 0600, base=20240101.1800"),
                                           ]),
    (_("20240101.1800 -> 20240102.1200"), [_("20240101.1800 -> 1900, base=20240101.1800"),
                                           _("20240101.1900 -> 2000, base=20240101.1800"),
                                           _("20240101.2000 -> 2100, base=20240101.1800"),
                                           _("20240101.2100 -> 2200, base=20240101.1800"),
                                           _("20240101.2200 -> 2300, base=20240101.1800"),
                                           _("20240101.2300 -> 20240102.0000, base=20240101.1800"),
                                           _("20240102.0000 -> 0100, base=20240101.1800"),
                                           _("20240102.0100 -> 0200, base=20240101.1800"),
                                           _("20240102.0200 -> 0300, base=20240101.1800"),
                                           _("20240102.0300 -> 0400, base=20240101.1800"),
                                           _("20240102.0400 -> 0500, base=20240101.1800"),
                                           _("20240102.0500 -> 0600, base=20240101.1800"),
                                           _("20240102.0600 -> 0700, base=20240101.1800"),
                                           _("20240102.0700 -> 0800, base=20240101.1800"),
                                           _("20240102.0800 -> 0900, base=20240101.1800"),
                                           _("20240102.0900 -> 1000, base=20240101.1800"),
                                           _("20240102.1000 -> 1100, base=20240101.1800"),
                                           _("20240102.1100 -> 1200, base=20240101.1800"),
                                           ]),
    (_("20240101.1800 -> 20240101.0600"), [_("20240101.1800 -> 20240101.1700, base=20240101.0600"),
                                           _("20240101.1700 -> 20240101.1600, base=20240101.0600"),
                                           _("20240101.1600 -> 20240101.1500, base=20240101.0600"),
                                           _("20240101.1500 -> 20240101.1400, base=20240101.0600"),
                                           _("20240101.1400 -> 20240101.1300, base=20240101.0600"),
                                           _("20240101.1300 -> 20240101.1200, base=20240101.0600"),
                                           _("20240101.1200 -> 20240101.1100, base=20240101.0600"),
                                           _("20240101.1100 -> 20240101.1000, base=20240101.0600"),
                                           _("20240101.1000 -> 20240101.0900, base=20240101.0600"),
                                           _("20240101.0900 -> 20240101.0800, base=20240101.0600"),
                                           _("20240101.0800 -> 20240101.0700, base=20240101.0600"),
                                           _("20240101.0700 -> 20240101.0600, base=20240101.0600"),
                                           ]),
    (_("20240101.0000 -> 20240103.1515"), None),
    (_("20240101.1800 -> 20290103.0000"), None),
]

ENDA_TEST_CASES = [
    (_("20240102.0900 -> 20240102.1200"), [_("20240102.0900 -> 20240102.1200, base=20240102.0600")]),
    (_("20240102.0600 -> 20240102.0900"), [_("20240102.0600 -> 20240102.0900, base=20240102.0600")]),
    (
        _("20240102.1500 -> 20240102.2100"),
        [
            _("20240102.1500 -> 20240102.1800, base=20240102.0600"),
            _("20240102.1800 -> 20240102.2100, base=20240102.0600"),  # do not use base=20240102.1800
        ],
    ),
    (
        _("20240102.0900 -> 20240102.2100"),
        [
            _("20240102.0900 -> 20240102.1200, base=20240102.0600"),
            _("20240102.1200 -> 20240102.1500, base=20240102.0600"),
            _("20240102.1500 -> 20240102.1800, base=20240102.0600"),
            _("20240102.1800 -> 20240102.2100, base=20240102.0600"),
        ],
    ),
    (
        _("20240102.0900 -> 20240103.0600"),
        [
            _("20240102.0900 -> 20240102.1200, base=20240102.0600"),
            _("20240102.1200 -> 20240102.1500, base=20240102.0600"),
            _("20240102.1500 -> 20240102.1800, base=20240102.0600"),
            _("20240102.1800 -> 20240102.2100, base=20240102.0600"),
            _("20240102.2100 -> 20240103.0000, base=20240102.0600"),
            _("20240103.0000 -> 20240103.0300, base=20240102.1800"),
            _("20240103.0300 -> 20240103.0600, base=20240102.1800"),
        ],
    ),
    (
        _("20240102.0900 -> 20240103.2100"),
        [
            _("20240102.0900 -> 20240102.1200, base=20240102.0600"),
            _("20240102.1200 -> 20240102.1500, base=20240102.0600"),
            _("20240102.1500 -> 20240102.1800, base=20240102.0600"),
            _("20240102.1800 -> 20240102.2100, base=20240102.0600"),
            _("20240102.2100 -> 20240103.0000, base=20240102.0600"),
            _("20240103.0000 -> 20240103.0300, base=20240102.1800"),
            _("20240103.0300 -> 20240103.0600, base=20240102.1800"),
            _(
                "20240103.0600 -> 20240103.0900, base=20240102.1800"
            ),  # do not use base=20240103.0600, to avoid extra base change
            _(
                "20240103.0900 -> 20240103.1200, base=20240102.1800"
            ),  # do not use base=20240103.0600, to avoid extra base change
            _(
                "20240103.1200 -> 20240103.1500, base=20240103.0600"
            ),  # now do use base=20240103.0600 because step [21-24] is not available
            _("20240103.1500 -> 20240103.1800, base=20240103.0600"),
            _("20240103.1800 -> 20240103.2100, base=20240103.0600"),
        ],
    ),
    (
        _("20240102.0600 -> 20240102.1200"),
        [
            _("20240102.0600 -> 20240102.0900, base=20240102.0600"),
            _("20240102.0900 -> 20240102.1200, base=20240102.0600"),
        ],
    ),
]

GRIB_INDEX_TEST_CASE = [
    (
        _("20240102.0900 -> 20240102.1200"),
        [_("20240102.0900 -> 1000"), _("20240102.1000 -> 1100"), _("20240102.1100 -> 1200")],
    ),
]